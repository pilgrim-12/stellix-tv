<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export Channels from Firebase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #00d9ff; }
    .card {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    button {
      background: #00d9ff;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background: #00b8d4; }
    button:disabled { background: #666; cursor: not-allowed; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .stat-box {
      background: #0f3460;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-value { font-size: 24px; font-weight: bold; color: #00d9ff; }
    .stat-label { font-size: 12px; color: #aaa; }
    #log {
      background: #0a0a15;
      padding: 15px;
      border-radius: 6px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .log-info { color: #00d9ff; }
    .log-success { color: #4caf50; }
    .log-error { color: #f44336; }
    .log-warn { color: #ff9800; }
    pre {
      background: #0a0a15;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    input {
      background: #0f3460;
      border: 1px solid #333;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      width: 100%;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Firebase Channel Exporter</h1>

  <div class="card">
    <h3>Firebase Config</h3>
    <p>Enter your Firebase config (from .env.local):</p>
    <input type="text" id="apiKey" placeholder="API Key">
    <input type="text" id="projectId" placeholder="Project ID">
    <button onclick="initFirebase()">Connect to Firebase</button>
    <span id="connectionStatus"></span>
  </div>

  <div class="card">
    <h3>Export Options</h3>
    <button onclick="exportAllChannels()" id="btnExportAll" disabled>Export ALL Channels (11,000+ reads!)</button>
    <button onclick="exportAllPlaylists()" id="btnExportPlaylists" disabled>Export Playlists</button>
    <button onclick="exportActiveOnly()" id="btnExportActive" disabled>Export Active Only</button>
  </div>

  <div class="card">
    <h3>Statistics</h3>
    <div class="stats" id="stats">
      <div class="stat-box"><div class="stat-value" id="totalChannels">-</div><div class="stat-label">Total Channels</div></div>
      <div class="stat-box"><div class="stat-value" id="activeChannels">-</div><div class="stat-label">Active</div></div>
      <div class="stat-box"><div class="stat-value" id="pendingChannels">-</div><div class="stat-label">Pending</div></div>
      <div class="stat-box"><div class="stat-value" id="brokenChannels">-</div><div class="stat-label">Broken</div></div>
      <div class="stat-box"><div class="stat-value" id="uniqueUrls">-</div><div class="stat-label">Unique URLs</div></div>
      <div class="stat-box"><div class="stat-value" id="duplicates">-</div><div class="stat-label">Duplicates</div></div>
    </div>
  </div>

  <div class="card">
    <h3>Log</h3>
    <div id="log"></div>
  </div>

  <div class="card">
    <h3>Duplicate Analysis</h3>
    <button onclick="analyzeDuplicates()" id="btnAnalyze" disabled>Analyze Duplicates</button>
    <div id="duplicatesList"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    let db = null;
    let allChannels = [];
    let allPlaylists = [];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="log-${type}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    window.initFirebase = async function() {
      const apiKey = document.getElementById('apiKey').value;
      const projectId = document.getElementById('projectId').value;

      if (!apiKey || !projectId) {
        log('Please enter API Key and Project ID', 'error');
        return;
      }

      try {
        const app = initializeApp({
          apiKey,
          authDomain: `${projectId}.firebaseapp.com`,
          projectId,
        });
        db = getFirestore(app);

        document.getElementById('connectionStatus').textContent = ' Connected!';
        document.getElementById('connectionStatus').style.color = '#4caf50';

        // Enable buttons
        document.getElementById('btnExportAll').disabled = false;
        document.getElementById('btnExportPlaylists').disabled = false;
        document.getElementById('btnExportActive').disabled = false;
        document.getElementById('btnAnalyze').disabled = false;

        log('Connected to Firebase successfully', 'success');
      } catch (error) {
        log(`Connection error: ${error.message}`, 'error');
      }
    };

    window.exportAllChannels = async function() {
      if (!db) return;

      log('Starting export of ALL channels...', 'info');
      log('WARNING: This will consume ~11,000 reads!', 'warn');

      try {
        const channelsRef = collection(db, 'channels');
        const snapshot = await getDocs(channelsRef);

        allChannels = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        log(`Loaded ${allChannels.length} channels`, 'success');

        // Update stats
        updateStats();

        // Download JSON
        downloadJSON(allChannels, 'all-channels.json');
        log('Downloaded all-channels.json', 'success');

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    };

    window.exportActiveOnly = async function() {
      if (!db) return;

      log('Exporting active channels only...', 'info');

      try {
        const channelsRef = collection(db, 'channels');
        const q = query(channelsRef, where('status', '==', 'active'));
        const snapshot = await getDocs(q);

        const activeChannels = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        log(`Loaded ${activeChannels.length} active channels`, 'success');
        downloadJSON(activeChannels, 'active-channels.json');

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    };

    window.exportAllPlaylists = async function() {
      if (!db) return;

      log('Exporting playlists...', 'info');

      try {
        const playlistsRef = collection(db, 'playlists');
        const snapshot = await getDocs(playlistsRef);

        allPlaylists = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        log(`Loaded ${allPlaylists.length} playlists`, 'success');
        downloadJSON(allPlaylists, 'playlists.json');

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
      }
    };

    window.analyzeDuplicates = async function() {
      if (allChannels.length === 0) {
        log('Please export channels first', 'warn');
        return;
      }

      log('Analyzing duplicates by URL...', 'info');

      // Group by URL
      const urlGroups = new Map();

      allChannels.forEach(ch => {
        const url = ch.url?.trim();
        if (!url) return;

        if (!urlGroups.has(url)) {
          urlGroups.set(url, []);
        }
        urlGroups.get(url).push(ch);
      });

      // Find duplicates
      const duplicates = [];
      urlGroups.forEach((channels, url) => {
        if (channels.length > 1) {
          duplicates.push({ url, channels });
        }
      });

      log(`Found ${duplicates.length} duplicate URL groups`, 'success');

      // Show duplicates
      const listDiv = document.getElementById('duplicatesList');
      listDiv.innerHTML = `<h4>${duplicates.length} Duplicate Groups Found</h4>`;

      duplicates.slice(0, 50).forEach((group, i) => {
        const channelNames = group.channels.map(ch => `${ch.name} (${ch.status || 'pending'})`).join(', ');
        listDiv.innerHTML += `<div style="margin: 10px 0; padding: 10px; background: #0f3460; border-radius: 4px;">
          <strong>Group ${i + 1}:</strong> ${group.channels.length} channels<br>
          <small style="color: #888;">URL: ${group.url.substring(0, 80)}...</small><br>
          <small>Channels: ${channelNames}</small>
        </div>`;
      });

      if (duplicates.length > 50) {
        listDiv.innerHTML += `<p>...and ${duplicates.length - 50} more groups</p>`;
      }

      // Download duplicates analysis
      downloadJSON(duplicates, 'duplicates-analysis.json');
    };

    function updateStats() {
      const urlSet = new Set();
      let duplicateCount = 0;

      allChannels.forEach(ch => {
        const url = ch.url?.trim();
        if (url) {
          if (urlSet.has(url)) {
            duplicateCount++;
          } else {
            urlSet.add(url);
          }
        }
      });

      document.getElementById('totalChannels').textContent = allChannels.length;
      document.getElementById('activeChannels').textContent = allChannels.filter(ch => ch.status === 'active').length;
      document.getElementById('pendingChannels').textContent = allChannels.filter(ch => !ch.status || ch.status === 'pending').length;
      document.getElementById('brokenChannels').textContent = allChannels.filter(ch => ch.status === 'broken').length;
      document.getElementById('uniqueUrls').textContent = urlSet.size;
      document.getElementById('duplicates').textContent = duplicateCount;
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
